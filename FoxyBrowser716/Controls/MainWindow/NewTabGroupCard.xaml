<?xml version="1.0" encoding="utf-8"?>
<UserControl
    x:Class="FoxyBrowser716.Controls.MainWindow.NewTabGroupCard"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    xmlns:generic="using:FoxyBrowser716.Controls.Generic"
    xmlns:material="using:Material.Icons.WinUI3"
    xmlns:mainWindow="using:FoxyBrowser716.Controls.MainWindow"
    xmlns:complex="using:FoxyBrowser716.DataObjects.Complex"
    xmlns:helpers="using:FoxyBrowser716.Controls.Helpers"
    mc:Ignorable="d" MinWidth="0" HorizontalAlignment="Stretch" SizeChanged="TabCard_OnSizeChanged">
    
    <UserControl.Resources>
        <helpers:ColorToBrushConverter x:Key="ColorToBrushConverter"/>
        <helpers:UrlToImageControlConverter x:Key="UrlToImageControlConverter"/>
    </UserControl.Resources>
    
    <Grid Name="Root" CornerRadius="5" BorderThickness="0" MinWidth="0" HorizontalAlignment="Stretch"
          Background="{x:Bind TabGroup.GroupColor, Converter={StaticResource ColorToBrushConverter}, Mode=OneWay}"
          AllowDrop="True"
          DragOver="Root_DragOver"
          Drop="Root_Drop"
          DragEnter="Root_DragEnter"
          DragLeave="Root_DragLeave">
        
        <Grid.ContextFlyout>
            <Flyout Placement="LeftEdgeAlignedTop">
                <Flyout.FlyoutPresenterStyle>
                    <Style TargetType="FlyoutPresenter">
                        <Setter Property="Background" Value="Transparent"/>
                        <Setter Property="BorderThickness" Value="0"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="CornerRadius" Value="0"/>
                        <Setter Property="MinWidth" Value="0"/>
                        <Setter Property="MinHeight" Value="0"/>
                    </Style>
                </Flyout.FlyoutPresenterStyle>
                
                <StackPanel x:Name="contextStack" BorderBrush="{x:Bind CurrentTheme.SecondaryBackgroundColor, Converter={StaticResource ColorToBrushConverter}, Mode=OneWay}"
                            Background="{x:Bind CurrentTheme.PrimaryBackgroundColorVeryTransparent, Converter={StaticResource ColorToBrushConverter}, Mode=OneWay}"
                            CornerRadius="8" 
                            BorderThickness="2" Margin="0">
                </StackPanel>
            </Flyout>
        </Grid.ContextFlyout>
        
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
        </Grid.RowDefinitions>
        
        <Grid Grid.Row="0" Name="TopBar" CornerRadius="5" BorderThickness="2" Height="26" MinWidth="0" HorizontalAlignment="Stretch">
            <Grid.ColumnDefinitions>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="*" MinWidth="0"/>
                <ColumnDefinition Width="Auto"/>
                <ColumnDefinition Width="Auto"/>

            </Grid.ColumnDefinitions>
            <generic:FIconButton Grid.Column="0" Width="21" Height="21" Margin="0,0,1,0" x:Name="ButtonCollapse" Content="{material:MaterialIconExt Kind=ExpandLess}" OnClick="ButtonCollapse_OnOnClick" CurrentTheme="{x:Bind CurrentTheme, Mode=OneWay}"/>
            <generic:FTextInput Grid.Column="1" Height="22" Margin="2,0" x:Name="Label" Text="{x:Bind TabGroup.Name, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}" CurrentTheme="{x:Bind CurrentTheme, Mode=OneWay}"/>
            <generic:FIconButton Grid.Column="2" MaxWidth="21" Height="21" MinWidth="0" Padding="3" Content="{material:MaterialIconExt Kind=ContentCopy}" OnClick="DuplicateButton_OnOnClick" CurrentTheme="{x:Bind CurrentTheme, Mode=OneWay}"/>
            <generic:FIconButton Grid.Column="3" MaxWidth="21" Height="21" MinWidth="0" Margin="0,0,1,0" x:Name="ButtonClose" Content="{material:MaterialIconExt Kind=Close}" OnClick="ButtonClose_OnOnClick"/>
        </Grid>
        
        <StackPanel Grid.Row="1" Name="TabHolder" Margin="0,0,0,3">
            <ListView ItemsSource="{x:Bind TabGroup.Tabs, Mode=OneWay}"
                      Background="{x:Bind CurrentTheme.PrimaryBackgroundColorSlightTransparent, Converter={StaticResource ColorToBrushConverter}, Mode=OneWay}"
                      CornerRadius="8"
                      SelectionMode="None"
                      IsItemClickEnabled="True"
                      CanReorderItems="True"
                      CanDragItems="True"
                      AllowDrop="True"
                      ItemClick="ListViewBase_OnItemClick"
                      DragItemsStarting="TabsList_DragItemsStarting"
                      DragItemsCompleted="TabsList_DragItemsCompleted"
                      DragOver="TabsList_DragOver"
                      Drop="TabsList_Drop">
                <ListView.ItemTemplate>
                    <DataTemplate x:DataType="complex:WebviewTab">
                        <mainWindow:NewTabCard Title="{x:Bind Info.Title, Mode=OneWay}"
                                               ForceHighlight="{x:Bind IsActive, Mode=OneWay}"
                                               Icon="{x:Bind Info.FavIconUrl, Converter={StaticResource UrlToImageControlConverter}, Mode=OneWay}"
                                               CurrentTheme="{x:Bind TabManager.Instance.CurrentTheme, Mode=OneWay}" 
                                               Tag="{x:Bind}"   
                                               OnClick="TabCard_OnClick" 
                                               CloseRequested="TabCard_OnCloseRequested"
                                               DuplicateRequested="TabCard_OnDuplicateRequested"
                                               MenuItemFactory="{x:Bind GetMenuItems, Mode=OneWay}"
                        />
                    </DataTemplate>
                </ListView.ItemTemplate>
                <ListView.ItemContainerStyle>
                    <Style TargetType="ListViewItem">
                        <Setter Property="HorizontalContentAlignment" Value="Stretch"/>
                        <Setter Property="Padding" Value="0"/>
                        <Setter Property="Margin" Value="0"/>
                        <Setter Property="MinHeight" Value="0"/>
                        <Setter Property="MinWidth" Value="0"/>
                        <Setter Property="Height" Value="26"/>
                        <Setter Property="Template">
                            <Setter.Value>
                                <ControlTemplate TargetType="ListViewItem">
                                    <ListViewItemPresenter
                                        ContentTransitions="{TemplateBinding ContentTransitions}"
                                        Control.IsTemplateFocusTarget="True"
                                        FocusVisualMargin="{TemplateBinding FocusVisualMargin}"
                                        DragBackground="Transparent"
                                        PlaceholderBackground="Transparent"
                                        PointerOverBackground="Transparent"
                                        SelectedBackground="Transparent"
                                        SelectedPointerOverBackground="Transparent"
                                        PressedBackground="Transparent"
                                        SelectedPressedBackground="Transparent"
                                        DisabledOpacity="{ThemeResource ListViewItemDisabledThemeOpacity}"
                                        DragOpacity="{ThemeResource ListViewItemDragThemeOpacity}"
                                        ReorderHintOffset="{ThemeResource ListViewItemReorderHintThemeOffset}"
                                        HorizontalContentAlignment="{TemplateBinding HorizontalContentAlignment}"
                                        VerticalContentAlignment="{TemplateBinding VerticalContentAlignment}"
                                        ContentMargin="{TemplateBinding Padding}"
                                        RevealBackground="Transparent"
                                        RevealBorderThickness="0"
                                        RevealBorderBrush="Transparent"/>
                                </ControlTemplate>
                            </Setter.Value>
                        </Setter>
                    </Style>
                </ListView.ItemContainerStyle>
            </ListView>
        </StackPanel>
    </Grid>
</UserControl>